(function(f,h){typeof exports=="object"&&typeof module<"u"?module.exports=h():typeof define=="function"&&define.amd?define(h):(f=typeof globalThis<"u"?globalThis:f||self,f.LegendControl=h())})(this,function(){"use strict";const f="",h=t=>Array.isArray(t)?t:[t],A=t=>Array.isArray(t)?t.reduce((e,n)=>({...e,[n]:!0}),{}):t,v=(t,e,n,s=0,o=100)=>(t-e)*(o-s)/(n-e)+s,k=(t,e)=>Array.from({length:Math.ceil(t.length/e)},(n,s)=>t.slice(s*e,s*e+e)),C=(...t)=>t[0].map((e,n)=>t.slice(1).reduce((s,o)=>[...s,o[n]],[e])),E=t=>t.length===2?t:[null,...t],j=t=>t.reduce((e,[n,s],o)=>(o===t.length-1?e.push([[n,null],s]):e.push([[n,t[o+1][0]],s]),e),[]),l=(t,e={})=>{const{classes:n,styles:s,attributes:o,content:r,appendTo:c}=e,i=document.createElement(t);return n&&h(n).forEach(a=>i.classList.add(a)),s&&Object.entries(s).forEach(a=>i.style.setProperty(...a)),o&&Object.entries(o).forEach(([a,p])=>{p||p===0?i.setAttribute(a,`${p}`):i.removeAttribute(a)}),r&&i.append(...h(r).filter(Boolean)),c&&c.appendChild(i),i},g=(t,e)=>{var o,r,c;const{labels:n={},unit:s=""}=e||{};return Array.isArray(t)?(o=n[`${t}`])!=null?o:t[0]===null?`< ${n[`${t[1]}`]||`${t[1]}${s}`}`:t[1]===null?`> ${n[`${t[0]}`]||`${t[0]}${s}`}`:t.map(i=>n[`${i}`]||`${i}${s}`).join(" - "):t!==null?(r=n[`${t}`])!=null?r:`${t}${s}`:(c=n.other)!=null?c:"other"},B=(t,e)=>{const{inputs:n,stops:s,min:o,max:r}=t,c=s.map(([i,a])=>`${a} ${v(i,o,r)}%`);return l("div",{classes:"gradient",content:[l("p",{classes:"labels",content:n.map(i=>{const a=g(i,e.metadata);return a&&l("span",{styles:{left:`${v(i,o,r)}%`},content:a})})}),l("div",{classes:"bar",styles:{"background-image":`linear-gradient(90deg, ${c})`}})]})},O=(t,e)=>{const{stops:n}=t;return l("ul",{classes:["list","list--color"],content:n.map(([s,o])=>{const r=g(s,e.metadata);return r&&l("li",{styles:{"--color":o},content:r})})})},D=(t,e)=>{switch(t.name){case"interpolate":return B(t,e);case"match":case"step":case"literal":return O(t,e);default:return}},M=(t,e)=>{const{stops:n}=t;return l("ul",{classes:"bubbles",content:n.sort((s,o)=>o[1]-s[1]).map(([s,o])=>{const r=g(s,e.metadata);return r&&l("li",{styles:{"--radius":`${o}px`},content:l("span",{content:r})})})})},x=(t,e,n)=>{const{stops:s}=t;return l("ul",{classes:["list","list--icons"],content:s.map(([o,r])=>{var b;const c=g(o,e.metadata);if(!c)return;const{height:i,width:a,data:p}=((b=n.style.getImage(r))==null?void 0:b.data)||{};if(!i||!a||!p)return;const d=Math.max(a,i),m=l("canvas",{attributes:{width:d,height:d}}),u=m.getContext("2d"),y=new ImageData(Uint8ClampedArray.from(p),a,i);return u==null||u.putImageData(y,(d-a)/2,(d-i)/2),l("li",{content:[l("img",{classes:["icon"],attributes:{src:m.toDataURL()}}),c]})})})},S={color:D,radius:M,image:x,pattern:x},_=(t,e)=>k(t.slice(e),2),$={interpolate:t=>_(t,2),match:t=>_(t,1).map(E),step:t=>j([[null,t[1]],..._(t,2)]),literal:t=>[[...t,...t]]},L=t=>Array.isArray(t)&&!!t.length&&typeof t[0]=="string",T={isExpression:L,parse:t=>{var a;const[e,...n]=L(t)?t:["literal",t],s=(a=$[e])==null?void 0:a.call($,n);if(!s)return null;const[o,r]=C(...s),c=Math.min(...o.flat(2)),i=Math.max(...o.flat(2));return{name:e,stops:s,inputs:o,outputs:r,min:c,max:i}}},w={collapsed:!1,toggler:!1,layers:void 0};class q{constructor(e={}){const{layers:n,...s}=e;this._container=l("div",{classes:["mapboxgl-ctrl","mapboxgl-ctrl-legend"]}),this._options={...w,...s,layers:A(n)},this._loadPanes=this._loadPanes.bind(this)}onAdd(e){return this._map=e,this._map.on("styledata",this._loadPanes),this._container}onRemove(){var e,n;(e=this._container.parentNode)==null||e.removeChild(this._container),(n=this._map)==null||n.off("styledata",this._loadPanes)}addLayers(e){this._options.layers={...this._options.layers,...A(e)},this._map.isStyleLoaded()&&this._loadPanes()}removeLayers(e){e.forEach(n=>{var o;(o=this._options.layers)==null||delete o[n];const s=document.querySelector(`.mapboxgl-ctrl-legend-pane--${n}`);s&&this._container.removeChild(s)})}_isAttributeVisible(e,n){const{layers:s}=this._options;if(!s)return!0;const o=Object.keys(s).find(c=>e.match(c)),r=!!o&&s[o];return Array.isArray(r)?r.includes(n):r}_getBlock(e,n,s){const[o]=n.split("-").slice(-1),r=S[o];if(!r)return;const c=T.parse(s);return c&&r(c,e,this._map)}_toggleButton(e){var o;if(!this._options.toggler)return;const n=((o=this._map)==null?void 0:o.getLayoutProperty(e,"visibility"))||"visible",s=l("div",{classes:["toggler",`toggler--${n}`]});return s.addEventListener("click",r=>{var i,a,p;r.preventDefault();const c=n==="none"?"visible":"none";(i=this._map)==null||i.setLayoutProperty(e,"visibility",c),(p=(a=this._options).onToggle)==null||p.call(a,e,c==="visible")}),s}_loadPanes(){const{collapsed:e,layers:n}=this._options;this._map.getStyle().layers.filter(s=>s.source&&s.source!=="composite").filter(({id:s})=>!n||Object.keys(n).some(o=>s.match(o))).reverse().forEach(s=>{const{id:o,layout:r,paint:c,metadata:i}=s,a=Object.entries({...r,...c}).reduce((u,[y,b])=>{if(!this._isAttributeVisible(o,y))return u;const P=this._getBlock(s,y,b);return P&&u.push(P),u},[]);if(!a.length)return;const p=`mapboxgl-ctrl-legend-pane--${o}`,d=this._container.querySelector(`.${p}`),m=l("details",{classes:["mapboxgl-ctrl-legend-pane",p],attributes:{open:d?d.getAttribute("open")!==null:!e},content:[l("summary",{content:[(i==null?void 0:i.name)||o,this._toggleButton(o)]}),...a]});d?this._container.replaceChild(m,d):this._container.appendChild(m)})}}return q});
